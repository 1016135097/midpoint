<?xml version="1.0" encoding="UTF-8"?>
<!--
  ~ Copyright (c) 2010-2013 Evolveum
  ~
  ~ Licensed under the Apache License, Version 2.0 (the "License");
  ~ you may not use this file except in compliance with the License.
  ~ You may obtain a copy of the License at
  ~
  ~     http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" BASIS,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ See the License for the specific language governing permissions and
  ~ limitations under the License.
  -->
<beans
    xmlns="http://www.springframework.org/schema/beans"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="
     http://www.springframework.org/schema/beans
     http://www.springframework.org/schema/beans/spring-beans-3.0.xsd"
	default-autowire="byName">
	
	<bean id="matchingRuleRegistry" class="com.evolveum.midpoint.prism.match.MatchingRuleRegistryFactory" 
    	factory-method="createRegistry">
    </bean>
    
    <bean id="clock" class="com.evolveum.midpoint.common.Clock">
    </bean>
    
    <bean id="activationComputer" class="com.evolveum.midpoint.common.ActivationComputer">
    	<property name="clock">
            <ref bean="clock"/>
        </property>
    </bean>
    
        <bean id="basicFunctionObject" class="com.evolveum.midpoint.common.expression.functions.BasicExpressionFunctions"
          scope="singleton">
          <constructor-arg name="prismContext" ref="prismContext"/>
          <constructor-arg name="protector" ref="protector"/>
    </bean>
    
    <bean id="basicFunctionObjectXml" class="com.evolveum.midpoint.common.expression.functions.BasicExpressionFunctionsXPath"
          scope="singleton">
          <constructor-arg type="com.evolveum.midpoint.common.expression.functions.BasicExpressionFunctions" ref="basicFunctionObject"/>
    </bean>
    
    <bean id="basicFunctionLibrary" class="com.evolveum.midpoint.common.expression.functions.FunctionLibrary"
          scope="singleton">
        <property name="variableName" value="basic"/>
        <property name="namespace" value="http://midpoint.evolveum.com/xml/ns/public/function/basic-2"/>
        <property name="genericFunctions">
            <ref bean="basicFunctionObject"/>
        </property>
        <property name="xmlFunctions">
            <ref bean="basicFunctionObjectXml"/>
        </property>
    </bean>

    <bean id="logFunctionObject" class="com.evolveum.midpoint.common.expression.functions.LogExpressionFunctions"
          scope="singleton">
          <constructor-arg name="prismContext" ref="prismContext"/>
    </bean>
    
    <bean id="logFunctionLibrary" class="com.evolveum.midpoint.common.expression.functions.FunctionLibrary"
          scope="singleton">
        <property name="variableName" value="log"/>
        <property name="namespace" value="http://midpoint.evolveum.com/xml/ns/public/function/log-2"/>
        <property name="genericFunctions">
            <ref bean="logFunctionObject"/>
        </property>
    </bean>
    
        <bean id="xpathScriptEvaluator" class="com.evolveum.midpoint.common.expression.script.xpath.XPathScriptEvaluator"
          scope="singleton">
          <constructor-arg name="prismContext" ref="prismContext"/>
    </bean>
    
    <bean id="javascriptScriptEvaluator" class="com.evolveum.midpoint.common.expression.script.jsr223.Jsr223ScriptEvaluator"
          scope="singleton">
          <constructor-arg name="engineName" value="JavaScript"/>
          <constructor-arg name="prismContext" ref="prismContext"/>
          <constructor-arg name="protector" ref="protector"/>
    </bean>

    <bean id="groovyScriptEvaluator" class="com.evolveum.midpoint.common.expression.script.jsr223.Jsr223ScriptEvaluator"
          scope="singleton">
          <constructor-arg name="engineName" value="groovy"/>
          <constructor-arg name="prismContext" ref="prismContext"/>
          <constructor-arg name="protector" ref="protector"/>
    </bean>
    
    <bean id="scriptExpressionFactory" class="com.evolveum.midpoint.common.expression.script.ScriptExpressionFactory"
          scope="singleton">
          <constructor-arg ref="modelObjectResolver"/>
          <constructor-arg name="prismContext" ref="prismContext"/>
          <constructor-arg>
        	<list>
        		<ref bean="basicFunctionLibrary"/>
        		<ref bean="logFunctionLibrary"/>
        		<ref bean="midpointFunctionLibrary"/>
        	</list>
        </constructor-arg>
        <constructor-arg name="protector" ref="protector"/>
          <constructor-arg>
        	<list>
        		<ref bean="xpathScriptEvaluator"/>
        		<ref bean="javascriptScriptEvaluator"/>
        		<ref bean="groovyScriptEvaluator"/>
        	</list>
        </constructor-arg>
    </bean>

    <bean id="scriptExpressionEvaluatorFactory" class="com.evolveum.midpoint.common.expression.script.ScriptExpressionEvaluatorFactory"
          scope="singleton">
          <constructor-arg ref="scriptExpressionFactory"/>
    </bean>
    
    <bean id="generateExpressionEvaluatorFactory" class="com.evolveum.midpoint.common.expression.evaluator.GenerateExpressionEvaluatorFactory"
          scope="singleton">
          <constructor-arg ref="protector"/>
          <constructor-arg ref="modelObjectResolver"/>
          <constructor-arg name="prismContext" ref="prismContext"/>
    </bean>
    
    <bean id="pathExpressionEvaluatorFactory" class="com.evolveum.midpoint.common.expression.evaluator.PathExpressionEvaluatorFactory"
          scope="singleton">
          <constructor-arg name="prismContext" ref="prismContext"/>
          <constructor-arg ref="modelObjectResolver"/>
          <constructor-arg name="protector" ref="protector"/>
    </bean>
    
    <bean id="literalExpressionEvaluatorFactory" class="com.evolveum.midpoint.common.expression.evaluator.LiteralExpressionEvaluatorFactory"
          scope="singleton">
          <constructor-arg name="prismContext" ref="prismContext"/>
    </bean>
    
    <bean id="asisExpressionEvaluatorFactory" 
          class="com.evolveum.midpoint.common.expression.evaluator.AsIsExpressionEvaluatorFactory"
          scope="singleton">
          <constructor-arg name="prismContext" ref="prismContext"/>
          <constructor-arg name="protector" ref="protector"/>
    </bean>

	<bean id="assignmentExpressionEvaluatorFactory" 
	      class="com.evolveum.midpoint.common.expression.evaluator.AssignmentExpressionEvaluatorFactory"
          scope="singleton">
          <constructor-arg name="prismContext" ref="prismContext"/>
          <constructor-arg name="protector" ref="protector"/>
    </bean>
    
    <bean id="expressionFactory" class="com.evolveum.midpoint.common.expression.ExpressionFactory" 
    		scope="singleton">
        <constructor-arg>
        	<ref bean="modelObjectResolver"/>
        </constructor-arg>
        <constructor-arg>
        	<ref bean="prismContext"/>
        </constructor-arg>
        <constructor-arg>
        	<list>
        		<ref bean="scriptExpressionEvaluatorFactory"/>
        		<ref bean="generateExpressionEvaluatorFactory"/>
        		<ref bean="pathExpressionEvaluatorFactory"/>
        		<ref bean="literalExpressionEvaluatorFactory"/>
        		<ref bean="asisExpressionEvaluatorFactory"/>
        		<ref bean="assignmentExpressionEvaluatorFactory"/>
        	</list>
        </constructor-arg>
        <property name="defaultEvaluatorFactory">
            <ref bean="asisExpressionEvaluatorFactory"/>
        </property>
    </bean>

    <bean id="mappingFactory" class="com.evolveum.midpoint.common.mapping.MappingFactory"
          scope="singleton">
        <property name="expressionFactory">
            <ref bean="expressionFactory"/>
        </property>
        <property name="objectResolver">
            <ref bean="modelObjectResolver"/>
        </property>
        <property name="protector">
            <ref bean="protector"/>
        </property>
        <property name="prismContext">
            <ref bean="prismContext"/>
        </property>
        <property name="filterManager">
            <ref bean="filterManager"/>
        </property>
    </bean>

</beans>
