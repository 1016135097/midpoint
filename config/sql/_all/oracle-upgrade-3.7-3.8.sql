CREATE TABLE m_audit_event_new (
  id                NUMBER(19, 0) GENERATED BY DEFAULT ON NULL AS IDENTITY,
  attorneyName      VARCHAR2(255 CHAR),
  attorneyOid       VARCHAR2(36 CHAR),
  channel           VARCHAR2(255 CHAR),
  eventIdentifier   VARCHAR2(255 CHAR),
  eventStage        NUMBER(10, 0),
  eventType         NUMBER(10, 0),
  hostIdentifier    VARCHAR2(255 CHAR),
  initiatorName     VARCHAR2(255 CHAR),
  initiatorOid      VARCHAR2(36 CHAR),
  initiatorType     NUMBER(10, 0),
  message           VARCHAR2(1024 CHAR),
  nodeIdentifier    VARCHAR2(255 CHAR),
  outcome           NUMBER(10, 0),
  parameter         VARCHAR2(255 CHAR),
  remoteHostAddress VARCHAR2(255 CHAR),
  result            VARCHAR2(255 CHAR),
  sessionIdentifier VARCHAR2(255 CHAR),
  targetName        VARCHAR2(255 CHAR),
  targetOid         VARCHAR2(36 CHAR),
  targetOwnerName   VARCHAR2(255 CHAR),
  targetOwnerOid    VARCHAR2(36 CHAR),
  targetType        NUMBER(10, 0),
  taskIdentifier    VARCHAR2(255 CHAR),
  taskOID           VARCHAR2(255 CHAR),
  timestampValue    TIMESTAMP,
  PRIMARY KEY (id)
) INITRANS 30;

CREATE TABLE m_audit_prop_value_new (
  id        NUMBER(19, 0) GENERATED BY DEFAULT ON NULL AS IDENTITY,
  name      VARCHAR2(255 CHAR),
  record_id NUMBER(19, 0),
  value     VARCHAR2(1024 CHAR),
  PRIMARY KEY (id)
) INITRANS 30;

CREATE TABLE m_audit_ref_value_new (
  id              NUMBER(19, 0) GENERATED BY DEFAULT ON NULL AS IDENTITY,
  name            VARCHAR2(255 CHAR),
  oid             VARCHAR2(255 CHAR),
  record_id       NUMBER(19, 0),
  targetName_norm VARCHAR2(255 CHAR),
  targetName_orig VARCHAR2(255 CHAR),
  type            VARCHAR2(255 CHAR),
  PRIMARY KEY (id)
) INITRANS 30;

INSERT INTO m_audit_event_new (id, attorneyName, attorneyOid, channel, eventIdentifier, eventStage, eventType, hostIdentifier,
                               initiatorName, initiatorOid, initiatorType, message, nodeIdentifier, outcome, parameter, remoteHostAddress,
                               result, sessionIdentifier, targetName, targetOid, targetOwnerName, targetOwnerOid, targetType,
                               taskIdentifier, taskOID, timestampValue)
  SELECT id, attorneyName, attorneyOid, channel, eventIdentifier, eventStage, eventType, hostIdentifier, initiatorName, initiatorOid,
    initiatorType, message, nodeIdentifier, outcome, parameter, remoteHostAddress, result, sessionIdentifier, targetName, targetOid,
    targetOwnerName, targetOwnerOid, targetType, taskIdentifier, taskOID, timestampValue
  FROM M_AUDIT_EVENT;

INSERT INTO m_audit_prop_value_NEW (id, name, record_id, value)
  SELECT id, name, record_id, value FROM m_audit_prop_value;

INSERT INTO m_audit_ref_value_NEW (id, name, oid, record_id, targetName_norm, targetName_orig, type)
  SELECT id, name, oid, record_id, targetName_norm, targetName_orig, type FROM m_audit_ref_value;

ALTER TABLE m_audit_event_new MODIFY id GENERATED AS IDENTITY START WITH LIMIT VALUE;
ALTER TABLE m_audit_prop_value_new MODIFY id GENERATED AS IDENTITY START WITH LIMIT VALUE;
ALTER TABLE m_audit_ref_value_new MODIFY id GENERATED AS IDENTITY START WITH LIMIT VALUE;

ALTER TABLE m_audit_delta DROP CONSTRAINT fk_audit_delta;
ALTER TABLE m_audit_item DROP CONSTRAINT fk_audit_item;
ALTER TABLE m_audit_prop_value DROP CONSTRAINT fk_audit_prop_value;
ALTER TABLE m_audit_ref_value DROP CONSTRAINT fk_audit_ref_value;

DROP TABLE m_audit_prop_value;
DROP TABLE m_audit_ref_value;
DROP TABLE m_audit_event;

ALTER TABLE m_audit_prop_value_new RENAME TO m_audit_prop_value;
ALTER TABLE m_audit_ref_value_new RENAME TO m_audit_ref_value;
ALTER TABLE m_audit_event_new RENAME TO m_audit_event;

CREATE INDEX iTimestampValue ON m_audit_event (timestampValue) INITRANS 30;
CREATE INDEX iAuditPropValRecordId ON m_audit_prop_value (record_id) INITRANS 30;
CREATE INDEX iAuditRefValRecordId ON m_audit_ref_value (record_id) INITRANS 30;

ALTER TABLE m_audit_delta ADD CONSTRAINT fk_audit_delta FOREIGN KEY (record_id) REFERENCES m_audit_event;
ALTER TABLE m_audit_item ADD CONSTRAINT fk_audit_item FOREIGN KEY (record_id) REFERENCES m_audit_event;
ALTER TABLE m_audit_prop_value ADD CONSTRAINT fk_audit_prop_value FOREIGN KEY (record_id) REFERENCES m_audit_event;
ALTER TABLE m_audit_ref_value ADD CONSTRAINT fk_audit_ref_value FOREIGN KEY (record_id) REFERENCES m_audit_event;