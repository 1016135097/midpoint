<?xml version="1.0" encoding="UTF-8"?>

<!--
  ~ Copyright (c) 2011 Evolveum
  ~
  ~ The contents of this file are subject to the terms
  ~ of the Common Development and Distribution License
  ~ (the License). You may not use this file except in
  ~ compliance with the License.
  ~
  ~ You can obtain a copy of the License at
  ~ http://www.opensource.org/licenses/cddl1 or
  ~ CDDLv1.0.txt file in the source code distribution.
  ~ See the License for the specific language governing
  ~ permission and limitations under the License.
  ~
  ~ If applicable, add the following below the CDDL Header,
  ~ with the fields enclosed by brackets [] replaced by
  ~ your own identifying information:
  ~
  ~ Portions Copyrighted 2011 [name of copyright owner]
  -->

<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:context="http://www.springframework.org/schema/context"
       xmlns:jaxws="http://cxf.apache.org/jaxws"
       xsi:schemaLocation="http://www.springframework.org/schema/beans
     http://www.springframework.org/schema/beans/spring-beans-3.0.xsd
     http://www.springframework.org/schema/context
     http://www.springframework.org/schema/context/spring-context-3.0.xsd



     http://cxf.apache.org/jaxws
     http://cxf.apache.org/schemas/jaxws.xsd"
       default-lazy-init="false"
       default-autowire="byName">

    <!-- enabling annotation driven configuration -->
    <context:annotation-config/>
    <context:component-scan base-package="com.evolveum.midpoint.model"/>
    <context:spring-configured/>

    <bean id="xpathExpressionEvaluator" class="com.evolveum.midpoint.common.expression.xpath.XPathExpressionEvaluator"
          scope="singleton">
    </bean>

    <bean id="expressionFactory" class="com.evolveum.midpoint.common.expression.ExpressionFactory"
          factory-method="createExpressionFactory" scope="singleton">
        <constructor-arg>
            <map>
                <entry key="http://www.w3.org/TR/xpath/" value-ref="xpathExpressionEvaluator"/>
            </map>
        </constructor-arg>
        <property name="objectResolver" ref="modelObjectResolver"/>
    </bean>

    <bean id="valueConstructionFactory" class="com.evolveum.midpoint.common.valueconstruction.ValueConstructionFactory"
          scope="singleton">
        <property name="expressionFactory">
            <ref bean="expressionFactory"/>
        </property>
    </bean>

    <!-- FIXME: THIS IS WRONG, IT SHOULD BE PULLED FROM COMMON -->
    <bean id="schemaRegistry" class="com.evolveum.midpoint.schema.SchemaRegistry" init-method="initialize"
          scope="singleton">
    </bean>

    <bean id="actionManager" class="com.evolveum.midpoint.model.sync.ActionManagerImpl">
        <property name="actionMapping">
            <map>
                <entry key="http://midpoint.evolveum.com/xml/ns/public/model/action-1#addUser">
                    <value type="java.lang.Class">com.evolveum.midpoint.model.sync.action.AddUserAction</value>
                </entry>
                <entry key="http://midpoint.evolveum.com/xml/ns/public/model/action-1#modifyUser">
                    <value type="java.lang.Class">com.evolveum.midpoint.model.sync.action.ModifyUserAction</value>
                </entry>
                <entry key="http://midpoint.evolveum.com/xml/ns/public/model/action-1#disableUser">
                    <value type="java.lang.Class">com.evolveum.midpoint.model.sync.action.DisableUserAction</value>
                </entry>
                <entry key="http://midpoint.evolveum.com/xml/ns/public/model/action-1#enableUser">
                    <value type="java.lang.Class">com.evolveum.midpoint.model.sync.action.EnableUserAction</value>
                </entry>
                <entry key="http://midpoint.evolveum.com/xml/ns/public/model/action-1#linkAccount">
                    <value type="java.lang.Class">com.evolveum.midpoint.model.sync.action.LinkAccountAction</value>
                </entry>
                <entry key="http://midpoint.evolveum.com/xml/ns/public/model/action-1#unlinkAccount">
                    <value type="java.lang.Class">com.evolveum.midpoint.model.sync.action.UnlinkAccountAction</value>
                </entry>
                <entry key="http://midpoint.evolveum.com/xml/ns/public/model/action-1#deleteAccount">
                    <value type="java.lang.Class">com.evolveum.midpoint.model.sync.action.DeleteAccountAction</value>
                </entry>
                <entry key="http://midpoint.evolveum.com/xml/ns/public/model/action-1#disableAccount">
                    <value type="java.lang.Class">com.evolveum.midpoint.model.sync.action.DisableAccountAction</value>
                </entry>
                <entry key="http://midpoint.evolveum.com/xml/ns/public/model/action-1#addAccount">
                    <value type="java.lang.Class">com.evolveum.midpoint.model.sync.action.AddAccountAction</value>
                </entry>
                <entry key="http://midpoint.evolveum.com/xml/ns/public/model/action-1#deleteUser">
                    <value type="java.lang.Class">com.evolveum.midpoint.model.sync.action.DeleteUserAction</value>
                </entry>
                <entry key="http://midpoint.evolveum.com/xml/ns/public/model/action-1#modifyPassword">
                    <value type="java.lang.Class">com.evolveum.midpoint.model.sync.action.ModifyPasswordAction</value>
                </entry>
            </map>
        </property>
        <property name="model">
            <ref bean="modelController"/>
        </property>
        <property name="synchronizer">
            <ref bean="userSynchronizer"/>
        </property>
        <property name="changeExecutor">
            <ref bean="changeExecutor"/>
        </property>
        <property name="schemaRegistry">
            <ref bean="schemaRegistry"/>
        </property>
    </bean>

    <bean id="filterManager" class="com.evolveum.midpoint.model.controller.FilterManagerImpl">
        <property name="filterMapping">
            <map>
                <entry key="http://midpoint.evolveum.com/xml/ns/public/common/value-filter-1.xsd#emptyFilter">
                    <value type="java.lang.Class">com.evolveum.midpoint.model.filter.EmptyFilter</value>
                </entry>
                <entry key="http://midpoint.evolveum.com/xml/ns/public/common/value-filter-1.xsd#patternFilter">
                    <value type="java.lang.Class">com.evolveum.midpoint.model.filter.PatternFilter</value>
                </entry>
                <entry key="http://midpoint.evolveum.com/xml/ns/public/common/value-filter-1.xsd#diacriticsFilter">
                    <value type="java.lang.Class">com.evolveum.midpoint.model.filter.DiacriticsFilter</value>
                </entry>
            </map>
        </property>
    </bean>

    <import resource="classpath:META-INF/cxf/cxf.xml"/>
    <import resource="classpath:META-INF/cxf/cxf-servlet.xml"/>

    <jaxws:endpoint id="modelWS"
                    address="/model">
        <jaxws:implementor>
            <bean parent="modelWebService"/>
        </jaxws:implementor>
        <jaxws:inInterceptors>
            <ref bean="authenticationInterceptor"/>
            <!--
                        <ref bean="authorizationInterceptor"/>
            -->
        </jaxws:inInterceptors>
    </jaxws:endpoint>

    <bean id="authenticationInterceptor" class="org.apache.cxf.ws.security.wss4j.WSS4JInInterceptor">
        <constructor-arg>
            <map>
                <entry key="action" value="UsernameToken"/>
                <entry key="passwordType" value="PasswordDigest"/>
                <entry key="passwordCallbackRef">
                    <ref bean="passwordCallback"/>
                </entry>
            </map>
        </constructor-arg>
    </bean>

    <bean id="passwordCallback" class="com.evolveum.midpoint.model.security.PasswordCallback">
        <constructor-arg name="userDetailsService" ref="userDetailsService"/>
        <constructor-arg name="protector" ref="protector"/>
    </bean>

    <!--Example of authorization for WS-->
    <!--
        <bean id="authorizationInterceptor" class="org.apache.cxf.interceptor.security.SimpleAuthorizingInterceptor">
            <property name="methodRolesMap">
                <map>
                    <entry key="getObject" value="ROLE_USER ROLE_ADMIN"/>
                    <entry key="addObject" value="ROLE_ADMIN"/>
                </map>
            </property>
        </bean>
    -->

</beans>
